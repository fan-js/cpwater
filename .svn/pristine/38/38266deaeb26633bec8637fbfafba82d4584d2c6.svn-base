/*
 *
 *
 */
package cn.ritac.mmbs.web.controller.sse;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import cn.ritac.mmbs.service.MQTTService;

/**
 *<b>Description:</b><br>
 * @author admin
 * @version V1.0<br>
 * @Note
 *<b>ProjectName:</b> mmbs
 *<br><b>ClassName:</b> SseController
 *<br><b>CreatTime:</b> 2019年5月8日下午3:16:00
 */

@RestController
@RequestMapping("/sendMsg")
public class SseController {
	@Autowired
	ApplicationContext applicationContext;
	@Autowired
	SendMsgCompletedListener sendMsgCompletedListener;
	@Autowired
	MQTTService mqttService;

	@GetMapping("/push")
	public SseEmitter push() {
		final SseEmitter emitter = new SseEmitter(0L);
		try {
			sendMsgCompletedListener.addSseEmitters(emitter);
		} catch (Exception e) {
			emitter.completeWithError(e);
		}

		return emitter;
	}

	@GetMapping("/callback")
	public void payCallback(@RequestParam String params) {
		String data = mqttService.SendCallback(params);
		applicationContext.publishEvent(new SendMsgCompletedEvent(this, data));

	}
}